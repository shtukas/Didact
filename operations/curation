#!/usr/bin/ruby

# encoding: UTF-8

require_relative "../Libs/loader.rb"

exit

$cache = {}

def size(uuid)
    return $cache[uuid] if $cache[uuid]
    puts "looking  : #{uuid}"
    count = XCache::getOrNull("a99a66c3-3a38-4dbd-a3ae-c1e6ecd506db:#{uuid}")
    if count then
        count = count.to_i
        $cache[uuid] = count
        return count.to_i 
    end
    puts "computing: #{uuid}"
    count = NetworkLinks::linkeduuids(uuid).count
    XCache::set("a99a66c3-3a38-4dbd-a3ae-c1e6ecd506db:#{uuid}", count)
    $cache[uuid] = count
    count
end

loop {
    objectuuid = TheIndex::objectuuids()
                    .reduce(nil){|objectuuid, uuid|
                        if size(objectuuid) > size(uuid) then
                            objectuuid
                        else
                            uuid
                        end
                    }
    item = TheIndex::getItemOrNull(objectuuid)
    raise "item is null" if item.nil?
    count = NetworkLinks::linkedEntities(item["uuid"]).count
    XCache::set("a99a66c3-3a38-4dbd-a3ae-c1e6ecd506db:#{item["uuid"]}", count)
    $cache[item["uuid"]] = count
    next if count == 0
    PolyPrograms::itemLanding(item)
    count = NetworkLinks::linkedEntities(item["uuid"]).count
    XCache::set("a99a66c3-3a38-4dbd-a3ae-c1e6ecd506db:#{item["uuid"]}", count)
    $cache[item["uuid"]] = count
}

exit

objectuuid = "efb38585-43fb-46dc-bdbb-1065fe30743e"
item = TheIndex::getItemOrNull(objectuuid)
relateduuids = NetworkLinks::linkeduuids(objectuuid) - ["d14d5d37-8c49-470b-b927-af7a9fb0a8f2"]
relateduuids.each{|uuid|
    NetworkArrows::link(objectuuid, uuid)
    NetworkLinks::unlink(objectuuid, uuid)
}

exit

objectuuid = "286a64a4-c9d2-49f6-8e7f-7edacea10ec6"
item = TheIndex::getItemOrNull(objectuuid)
relateduuids = NetworkLinks::linkeduuids(objectuuid) - []
relateduuids.each{|uuid|
    puts "recasting: #{uuid}"
    NetworkArrows::link(objectuuid, uuid)
    NetworkLinks::unlink(objectuuid, uuid)
}
exit